

# 第37节：后台登录页

前言：

先看src/layouts下的文件

[https://pro.ant.design/zh-CN/docs/layout#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B8%83%E5%B1%80](https://pro.ant.design/zh-CN/docs/layout#自定义布局)

## 1.新增登录页面的路由

`config/routes.js`

```js
export default [
  {
    path: '/admin',
    component: '../layouts/UserLayout',
    routes: [
      {
        name: 'login',
        path: '/admin/login',
        component: './Login',
      },
    ],
  },
];
```

## 2.新建Login页面

`src/pages/Login/index.jsx` `src/pages/Login/index.less`

src/assets下新增一张背景图index.jpg

```jsx
import React from 'react';
import { Form, Input, Button, Checkbox, Avatar } from 'antd';
import { UserOutlined, LockOutlined } from '@ant-design/icons';
import { connect, FormattedMessage, useIntl } from 'umi';
import './index.less';

const Login = (props) => {
  const intl = useIntl();
  const onFinish = (values) => {
    const { dispatch } = props;
    dispatch({
      type: 'login/login',
      payload: { ...values },
    });
  };

  return (
    <div className="login-form">
      <div className="login-form-shadow">
        <Form
          name="login"
          className="form"
          initialValues={{
            remember: true,
            userName: '',
            password: '',
          }}
          onFinish={onFinish}
        >
          <Form.Item
            name="userName"
            rules={[
              {
                required: true,
                message: intl.formatMessage({
                  id: 'login.p_userName',
                }),
              },
              {
                pattern: /^[\u4E00-\u9FA5A-Za-z0-9_]{5,20}$/,
                message: intl.formatMessage({
                  id: 'login.p_userName_pattern',
                }),
              },
            ]}
          >
            <Input
              style={{
                color: '#000',
              }}
              prefix={<UserOutlined className="site-form-item-icon" />}
              placeholder={intl.formatMessage({
                id: 'login.p_userName',
              })}
            />
          </Form.Item>
          <Form.Item
            name="password"
            rules={[
              {
                required: true,
                message: intl.formatMessage({
                  id: 'login.p_password',
                }),
              },
              {
                pattern: /^[A-Za-z0-9_]{6,20}$/,
                message: intl.formatMessage({
                  id: 'login.p_password_pattern',
                }),
              },
            ]}
          >
            <Input
              style={{
                color: '#000',
              }}
              prefix={<LockOutlined className="site-form-item-icon" />}
              type="password"
              placeholder={intl.formatMessage({
                id: 'login.p_password',
              })}
            />
          </Form.Item>
          {/* <Form.Item>
            <Form.Item name="remember" valuePropName="checked" noStyle>
              <Checkbox>自动登录</Checkbox>
            </Form.Item>
          </Form.Item> */}

          <Form.Item>
            <Button type="primary" htmlType="submit" className="login-form-button">
              <FormattedMessage id="login.login" />
            </Button>
          </Form.Item>
        </Form>
      </div>
    </div>
  );
};

export default connect(({ login, loading }) => ({
  userLogin: login,
  submitting: loading.effects['login/login'],
}))(Login);

```



```less

  .login-form{
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background:url('../../assets/index.jpg') center center no-repeat;
    .login-form-shadow{
        width: 400px;
        padding: 44px 20px 20px;
        background: #fff;
        box-shadow: 0 4px 12px 0;
    }
    .login-form-button{
        width: 100%;
    }
    .ant-input{
      color: #000;
    }
  }
```

## 3.定义国际化

> 我这里只设置三种语言（简体中文，繁体中文，英文）

### 1.先定义简体中文

#### A.在`src/locales/zh-CN`目录下新增`login.js`

```js
export default {
  'login.p_userName': '请输入用户名',
  'login.p_userName_pattern': '用户名5-20位',
  'login.p_password_pattern': '密码6-20位数字字母下划线组合',
  'login.p_password': '请输入密码',
  'login.login': '登录',
};
```

#### B.`src/locales/zh-CN.js`中导入上面定义的内容

```js
import component from './zh-CN/component';
import globalHeader from './zh-CN/globalHeader';
import menu from './zh-CN/menu';
import pwa from './zh-CN/pwa';
import settingDrawer from './zh-CN/settingDrawer';
import settings from './zh-CN/settings';
import pages from './zh-CN/pages';
import login from './zh-CN/login'; // 新增

export default {
  'navBar.lang': '语言',
  'layout.user.link.help': '帮助',
  'layout.user.link.privacy': '隐私',
  'layout.user.link.terms': '条款',
  'app.preview.down.block': '下载此页面到本地项目',
  'app.welcome.link.fetch-blocks': '获取全部区块',
  'app.welcome.link.block-list': '基于 block 开发，快速构建标准页面',
  ...pages,
  ...globalHeader,
  ...menu,
  ...settingDrawer,
  ...settings,
  ...pwa,
  ...component,
  ...login, // 新增
};

```



### 2.定义繁体中文

#### A.在`src/locales/zh-TW`目录下新增`login.js`

```JS
export default {
  'login.p_userName': '請輸入用戶名',
  'login.p_userName_pattern': '用戶名5-20比特',
  'login.p_password_pattern': '密碼6-20比特數位字母底線組合',
  'login.p_password': '請輸入密碼',
  'login.login': '登入',
};
```

#### B.`src/locales/zh-TW.js`中导入上面定义的内容

```JS
import component from './zh-TW/component';
import globalHeader from './zh-TW/globalHeader';
import menu from './zh-TW/menu';
import pwa from './zh-TW/pwa';
import settingDrawer from './zh-TW/settingDrawer';
import settings from './zh-TW/settings';
import login from './zh-TW/login';
export default {
  'navBar.lang': '語言',
  'layout.user.link.help': '幫助',
  'layout.user.link.privacy': '隱私',
  'layout.user.link.terms': '條款',
  'app.preview.down.block': '下載此頁面到本地項目',
  ...globalHeader,
  ...menu,
  ...settingDrawer,
  ...settings,
  ...pwa,
  ...component,
  ...login,
};

```

英文也是同样的操作。

### 3.定义英文

> 之后每个页面使用的国际化配置都像这样配置三种语言即可。根据自己的需求配置需要的语言。

#### A.在`src/locales/en-US`目录下新增`login.js`

```js
export default {
  'login.p_userName': 'Please input user name',
  'login.p_userName_pattern': 'user name 5-20 bits',
  'login.p_password_pattern': 'Password 6-20 digits, alphanumeric and underline combination ',
  'login.p_password': 'Please input password',
  'login.login': 'Login',
};

```

#### B.`src/locales/en-US.js`中导入上面定义的内容

```JS
import component from './en-US/component';
import globalHeader from './en-US/globalHeader';
import menu from './en-US/menu';
import pwa from './en-US/pwa';
import settingDrawer from './en-US/settingDrawer';
import settings from './en-US/settings';
import pages from './en-US/pages';
import login from './en-US/login';

export default {
  'navBar.lang': 'Languages',
  'layout.user.link.help': 'Help',
  'layout.user.link.privacy': 'Privacy',
  'layout.user.link.terms': 'Terms',
  'app.preview.down.block': 'Download this page to your local project',
  'app.welcome.link.fetch-blocks': 'Get all block',
  'app.welcome.link.block-list': 'Quickly build standard, pages based on `block` development',
  ...globalHeader,
  ...menu,
  ...settingDrawer,
  ...settings,
  ...pwa,
  ...component,
  ...pages,
  ...login,
};

```

## 4.修改UserLayout.jsx

`src/layouts/UserLayout.jsx`

```jsx
import { DefaultFooter, getMenuData, getPageTitle } from '@ant-design/pro-layout';
import { Helmet, HelmetProvider } from 'react-helmet-async';
import { useIntl, connect, FormattedMessage } from 'umi';
import React from 'react';
import SelectLang from '@/components/SelectLang';
import styles from './UserLayout.less';

const UserLayout = (props) => {
  const {
    route = {
      routes: [],
    },
  } = props;
  const { routes = [] } = route;
  const {
    children,
    location = {
      pathname: '',
    },
  } = props;
  const { formatMessage } = useIntl();
  const { breadcrumb } = getMenuData(routes);
  const title = getPageTitle({
    pathname: location.pathname,
    formatMessage,
    breadcrumb,
    ...props,
  });
  return (
    <HelmetProvider>
      <Helmet>
        <title>{title}</title>
        <meta name="description" content={title} />
      </Helmet>

      <div className={styles.container}>
        {/* <div className={styles.lang}>
          <SelectLang />
        </div> */}
        <div className={styles.content}>{children}</div>
        {/* <DefaultFooter
          copyright={`${new Date().getFullYear()} NeverGiveUpT`}
          links={[
            {
              key: 'desc',
              title: <FormattedMessage id="component.layout.footer" />,
            },
          ]}
        /> */}
      </div>
    </HelmetProvider>
  );
};

export default connect(({ settings }) => ({ ...settings }))(UserLayout);

```

`src/layouts/UserLayout.less`

```less
@import '~antd/es/style/themes/default.less';

.container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: auto;
  background: @layout-body-background;
}

.lang {
  width: 100%;
  height: 40px;
  line-height: 44px;
  text-align: right;
  :global(.ant-dropdown-trigger) {
    margin-right: 24px;
  }
}

.content {
  flex: 1;
  // padding: 32px 0;
}

@media (min-width: @screen-md-min) {
  .container {
    background-image: url('http://qc437ldbv.bkt.clouddn.com/27bd18d563594b9153e62376523731be.jpg');
    background-repeat: no-repeat;
    background-position: center 110px;
    background-size: 100%;
  }

  // .content {
  //   padding: 32px 0 24px;
  // }
}

.top {
  text-align: center;
}

.header {
  height: 44px;
  line-height: 44px;
  a {
    text-decoration: none;
  }
}

.logo {
  height: 44px;
  margin-right: 16px;
  vertical-align: top;
}

.title {
  position: relative;
  top: 2px;
  color: @heading-color;
  font-weight: 600;
  font-size: 33px;
  font-family: Avenir, 'Helvetica Neue', Arial, Helvetica, sans-serif;
}

.desc {
  margin-top: 12px;
  margin-bottom: 40px;
  color: @text-color-secondary;
  font-size: @font-size-base;
}

```

## 5.登录功能实现

> 后端的接口我们还没写，那么这里先直接使用我线上的接口：
>
> http://www.nevergiveupt.top:3000/api/v1/admin/login

### 1.修改src/models/login.js

```js
import { stringify } from 'querystring';
import { history } from 'umi';
import { fakeAccountLogin } from '@/services/login';
import { setAuthority } from '@/utils/authority';
import { getPageQuery } from '@/utils/utils';
import { message } from 'antd';

const Model = {
  namespace: 'login',
  state: {
    status: undefined,
  },
  effects: {
    // 点击登录后会调用下面的logn函数
    *login({ payload }, { call, put }) {
      const res = yield call(fakeAccountLogin, payload);
      if (res.data) {
        if (res.code === 0) {
          localStorage.setItem('token', res.data.token);
          localStorage.setItem('userName', res.data.userName);
          history.replace('/articles');
        }
      } else {
        message.error(res.msg);
      }
    },

    logout() {
      const { redirect } = getPageQuery(); // Note: There may be security issues, please note

      if (window.location.pathname !== '/user/login' && !redirect) {
        history.replace({
          pathname: '/user/login',
          search: stringify({
            redirect: window.location.href,
          }),
        });
      }
    },
  },
  reducers: {
    changeLoginStatus(state, { payload }) {
      setAuthority(payload.currentAuthority);
      return { ...state, status: payload.status, type: payload.type };
    },
  },
};
export default Model;

```

### 2.修改src/services/login.js

```js
import request from '@/utils/request';

export async function fakeAccountLogin(params) {
  return request('/admin/login', {
    method: 'POST',
    data: params,
  });
}

```

### 3.修改src/utils/request.js

```js
/** Request 网络请求工具 更详细的 api 文档: https://github.com/umijs/umi-request */
import { extend } from 'umi-request';
import { notification } from 'antd';

const codeMessage = {
  200: '服务器成功返回请求的数据。',
  201: '新建或修改数据成功。',
  202: '一个请求已经进入后台排队（异步任务）。',
  204: '删除数据成功。',
  400: '发出的请求有错误，服务器没有进行新建或修改数据的操作。',
  401: '用户没有权限（令牌、用户名、密码错误）。',
  403: '用户得到授权，但是访问是被禁止的。',
  404: '发出的请求针对的是不存在的记录，服务器没有进行操作。',
  406: '请求的格式不可得。',
  410: '请求的资源被永久删除，且不会再得到的。',
  422: '当创建一个对象时，发生一个验证错误。',
  500: '服务器发生错误，请检查服务器。',
  502: '网关错误。',
  503: '服务不可用，服务器暂时过载或维护。',
  504: '网关超时。',
};
/**
 * @zh-CN 异常处理程序
 * @en-US Exception handler
 */

const errorHandler = (error) => {
  const { response } = error;

  if (response && response.status) {
    const errorText = codeMessage[response.status] || response.statusText;
    const { status, url } = response;
    notification.error({
      message: `Request error ${status}: ${url}`,
      description: errorText,
    });
  } else if (!response) {
    notification.error({
      description: 'Your network is abnormal and cannot connect to the server',
      message: 'Network anomaly',
    });
  }

  return response;
};
/**
 * @en-US Configure the default parameters for request
 * @zh-CN 配置request请求时的默认参数
 */

const request = extend({
  prefix: '/api/v1', // 所有接口请求前面都加上
  errorHandler,
  // default error handling
  credentials: 'include', // Does the default request bring cookies
});

// 请求拦截器
request.interceptors.request.use((url, options) => {
  const method = options.method.toLocaleLowerCase();
  if (method === 'delete' || method === 'put') {
    const id = options.data.id ? options.data.id : options.data._id;
    url += '/' + id;
  }
  return {
    url,
    options: {
      ...options,
      interceptors: true,
      headers: {
        Authorization: 'Bearer ' + localStorage.getItem('token'),
      },
    },
  };
});

export default request;

```









































